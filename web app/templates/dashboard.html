<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Dashboard - EVAL</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard-vendor.css') }}">
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="user-profile">
                    <div class="user-avatar">
                        <svg width="80" height="80" viewBox="0 0 80 80">
                            <circle cx="40" cy="40" r="40" fill="#4A5F7F"/>
                            <circle cx="40" cy="30" r="12" fill="white"/>
                            <path d="M 20 60 Q 40 50, 60 60" fill="white"/>
                        </svg>
                    </div>
                    <h3 class="user-title">USER PROFILE</h3>
                    <p class="user-id">ID: {{ user_id[:12] }}</p>
                </div>
            </div>
            
            <nav class="sidebar-nav">
                <a href="{{ url_for('dashboard') }}" class="nav-item active">
                    <span class="nav-icon">üìä</span>
                    <span class="nav-text">Dashboard</span>
                </a>
                <a href="{{ url_for('upload_rfp_page') }}" class="nav-item">
                    <span class="nav-icon">üìÅ</span>
                    <span class="nav-text">Upload RFP</span>
                </a>
                <a href="#" class="nav-item" id="evaluation-nav">
                    <span class="nav-icon">üìã</span>
                    <span class="nav-text">Evaluation Results</span>
                </a>
                <a href="{{ url_for('chatbot_page') }}" class="nav-item" id="chatbot-nav">
                    <span class="nav-icon">üí¨</span>
                    <span class="nav-text">Chatbot Assistant</span>
                </a>
                <a href="#" class="nav-item">
                    <span class="nav-icon">üîñ</span>
                    <span class="nav-text">Saved Analyses</span>
                </a>
            </nav>
            
            <div class="sidebar-section">
                <h4 class="section-title">COMPARE PROPOSALS</h4>
            </div>
            
            <nav class="sidebar-nav sidebar-nav-bottom">
                <a href="#" class="nav-item">
                    <span class="nav-icon">üìÑ</span>
                    <span class="nav-text">Criteria Definitions</span>
                </a>
                <a href="#" class="nav-item">
                    <span class="nav-icon">üí°</span>
                    <span class="nav-text">Insights</span>
                </a>
                <a href="#" class="nav-item">
                    <span class="nav-icon">üìä</span>
                    <span class="nav-text">Reports</span>
                </a>
                <a href="{{ url_for('files_page') }}" class="nav-item">
                    <span class="nav-icon">üë§</span>
                    <span class="nav-text">My Profile</span>
                </a>
                <a href="#" class="nav-item">
                    <span class="nav-icon">‚öôÔ∏è</span>
                    <span class="nav-text">Settings</span>
                </a>
            </nav>
        </aside>
        
        <!-- Main Content -->
        <main class="main-content">
            <header class="page-header">
                <div class="logo-small">
                    <span class="logo-text-small">EVAL</span>
                </div>
                <h1 class="page-title">Dashboard</h1>
            </header>
            
            <!-- New vendor-scoring area -->
            <section class="content-area">
                <div class="content-inner">
                    <div class="top-controls">
                        <div>
                            <button class="process-button" id="process-button-ui">
                                <span class="button-text">Process Documents</span>
                            </button>
                        </div>
                        <div id="status-msg" class="status-msg"></div>
                    </div>

                    <h2 class="section-heading">Vendor Comparison</h2>

                    <div id="vendor-score-container" class="vendor-grid">
                        <!-- Vendor cards will be injected here -->
                    </div>

                    <div id="no-scores" class="files-empty" style="display:none;">
                        <div class="empty-icon">üì≠</div>
                        <h3>No scoring results yet</h3>
                        <p>Upload an RFP and vendor responses, then click "Process Documents" to run scoring.</p>
                    </div>
                </div>
            </section>
        </main>
    </div>
    
    <!-- Processing Modal -->
    <div class="modal" id="processing-modal">
        <div class="modal-content">
            <div class="modal-loader"></div>
            <h3>Processing Documents...</h3>
            <p>Processing in the web UI uses a simplified flow. This may take a few minutes depending on file sizes.</p>
        </div>
    </div>
    
    <script>
    // UI bindings & fetch logic

    async function fetchStatus() {
        const res = await fetch('/api/get-status');
        return await res.json();
    }

    async function loadVendorScores() {
        const res = await fetch('/api/get-scores');
        const data = await res.json();

        const container = document.getElementById('vendor-score-container');
        const noScores = document.getElementById('no-scores');

        if (!data.success || !data.scores || Object.keys(data.scores.vendors || {}).length === 0) {
            container.innerHTML = '';
            noScores.style.display = 'block';
            return;
        }

        noScores.style.display = 'none';
        container.innerHTML = '';

        const vendors = Object.values(data.scores.vendors);

        // Sort vendors by total score (descending)
        vendors.sort((a, b) => (b.total_score || 0) - (a.total_score || 0));

        vendors.forEach(vendor => {
            // Safe default values
            const total = vendor.total_score !== undefined ? vendor.total_score.toFixed(1) : 'N/A';
            const conf = vendor.confidence_score !== undefined ? (vendor.confidence_score * 100).toFixed(0) + '%' : 'N/A';
            const strengths = vendor.strengths || [];
            const weaknesses = vendor.weaknesses || [];
            const criteria = vendor.criteria_breakdown || [];

            const card = document.createElement('div');
            card.className = 'vendor-card';

            card.innerHTML = `
                <div class="card-head">
                    <h3 class="vendor-title">${vendor.vendor_name || 'Unnamed Vendor'}</h3>
                    <div class="vendor-badges">
                        <span class="badge score-badge">Total Score: ${total}</span>
                    </div>
                </div>

                <div class="card-row">
                    <div class="card-col">
                        <h4>Strengths:</h4>
                        <ul class="list-box strengths-list">
                            ${strengths.length ? strengths.map(s => `<li>${s}</li>`).join('') : '<li>No strengths identified</li>'}
                        </ul>
                    </div>

                    <div class="card-col">
                        <h4>Weaknesses:</h4>
                        <ul class="list-box weaknesses-list">
                            ${weaknesses.length ? weaknesses.map(w => `<li>${w}</li>`).join('') : '<li>No weaknesses identified</li>'}
                        </ul>
                    </div>
                </div>

                <h4 class="criteria-heading">Criteria Breakdown:</h4>
                <div class="criteria-box">
                    ${criteria.map(c => {
                        const evidenceList = (c.evidence || []);
                        const gapsList = (c.gaps || []);
                        
                        return `
                        <div class="criterion">
                            <div class="crit-meta">
                                <strong>${c.criterion_name} (Weighted: ${c.weighted_score !== undefined ? c.weighted_score.toFixed(1) : 'N/A'})</strong>
                                <span class="crit-scores">Confidence: ${c.confidence !== undefined ? (c.confidence * 100).toFixed(0) + '%' : 'N/A'}</span>
                            </div>
                            <div class="crit-sub">
                                <details>
                                    <summary>Evidence (${evidenceList.length})</summary>
                                    ${evidenceList.length ? `
                                        <ul>
                                            ${evidenceList.map(ev => `<li>${ev}</li>`).join('')}
                                        </ul>
                                    ` : '<p style="font-size: 0.85rem; color: #888; margin-top: 0.5rem;">No evidence provided</p>'}
                                </details>
                                <details>
                                    <summary>Gaps (${gapsList.length})</summary>
                                    ${gapsList.length ? `
                                        <ul>
                                            ${gapsList.map(g => `<li>${g}</li>`).join('')}
                                        </ul>
                                    ` : '<p style="font-size: 0.85rem; color: #888; margin-top: 0.5rem;">No gaps identified</p>'}
                                </details>
                            </div>
                        </div>
                        `;
                    }).join('')}
                </div>
            `;

            container.appendChild(card);
        });
    }

    document.getElementById('process-button-ui').addEventListener('click', async () => {
        // Show modal
        const modal = document.getElementById('processing-modal');
        const button = document.getElementById('process-button-ui');
        
        modal.classList.add('show');
        button.disabled = true;

        try {
            const res = await fetch('/api/process-documents', {method: 'POST'});
            const data = await res.json();
            const status = document.getElementById('status-msg');

            if (data.success) {
                status.textContent = `‚úì Processing complete! ${data.vendors_scored || 0} vendors scored.`;
                status.style.background = 'rgba(76, 175, 80, 0.15)';
                status.style.color = '#2e7d32';
                await loadVendorScores();
            } else {
                status.textContent = '‚úó Processing failed: ' + (data.message || 'Unknown error');
                status.style.background = 'rgba(244, 67, 54, 0.15)';
                status.style.color = '#c62828';
            }
        } catch (err) {
            const status = document.getElementById('status-msg');
            status.textContent = '‚úó Processing failed: ' + err.message;
            status.style.background = 'rgba(244, 67, 54, 0.15)';
            status.style.color = '#c62828';
        } finally {
            // Hide modal
            modal.classList.remove('show');
            button.disabled = false;
        }
    });

    // Initial load
    window.addEventListener('load', async () => {
        await loadVendorScores();
    });
    </script>
</body>
</html>